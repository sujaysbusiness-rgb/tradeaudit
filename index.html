<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeAudit Pro | Advanced Performance Review</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; color: #1e293b; }
        
        /* Print Styles */
        @media print {
            body { background-color: white; }
            .no-print { display: none !important; }
            .print-break { break-inside: avoid; }
            .shadow-sm { box-shadow: none !important; border: 1px solid #e2e8f0; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 18, className }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- ANALYSIS ENGINE ---
        const useTradeAnalysis = (rawText) => {
            return useMemo(() => {
                if (!rawText) return null;
                
                try {
                    const lines = rawText.split('\n').filter(l => l.trim());
                    if (lines.length < 2) throw new Error("Invalid CSV format");
                    
                    const headers = lines[0].split(',').map(h => h.trim());
                    const rows = lines.slice(1).map(line => {
                        const values = line.split(',');
                        const row = {};
                        headers.forEach((h, i) => row[h] = values[i] ? values[i].trim() : '');
                        return row;
                    });

                    const tradesMap = new Map();
                    const parseNum = (s) => parseFloat((s || '0').replace(/,/g, '')) || 0;
                    
                    rows.forEach(row => {
                        const sec = row['Security Name'];
                        if (!sec) return;
                        
                        // Date Parsing
                        const dStr = row['Trade Date'];
                        const tStr = row['Trade Time'] || '00:00:00';
                        if (!dStr) return;
                        const [dd, mm, yyyy] = dStr.split('/');
                        const dateObj = new Date(`${yyyy}-${mm}-${dd}T${tStr.toLowerCase() === 'nan' ? '00:00:00' : tStr}`);

                        // Calc
                        const qty = parseNum(row['Quantity']);
                        const price = parseNum(row['Market Rate']);
                        const charges = parseNum(row['Total Charges']);
                        const isBuy = (row['Transaction Type'] || '').toLowerCase() === 'buy';
                        const amount = qty * price;
                        const cashflow = isBuy ? -amount : amount;

                        if (!tradesMap.has(sec)) {
                            tradesMap.set(sec, {
                                id: sec,
                                netPnL: 0,
                                charges: 0,
                                grossPnL: 0, // Raw trade result
                                entryTime: dateObj,
                                exitTime: dateObj,
                                legs: 0
                            });
                        }
                        
                        const t = tradesMap.get(sec);
                        t.netPnL += (cashflow - charges);
                        t.charges += charges;
                        t.legs++;
                        if (dateObj < t.entryTime) t.entryTime = dateObj;
                        if (dateObj > t.exitTime) t.exitTime = dateObj;
                    });

                    const trades = Array.from(tradesMap.values())
                        .map(t => ({
                            ...t,
                            durationMins: (t.exitTime - t.entryTime) / 60000,
                            monthKey: t.exitTime.toLocaleString('default', { month: 'short', year: '2-digit' }), // Dec-24
                            dateStr: t.exitTime.toISOString().split('T')[0]
                        }))
                        .sort((a, b) => a.exitTime - b.exitTime);

                    if (trades.length === 0) throw new Error("No valid trades extracted");

                    // Metrics
                    let wins=0, losses=0, sumWin=0, sumLoss=0;
                    let equity=0, peak=0, maxDD=0;
                    let currentStreak=0, maxWinStreak=0, maxLossStreak=0;
                    const equityCurve = [];
                    const monthlyStats = {};

                    trades.forEach(t => {
                        // Monthly
                        if (!monthlyStats[t.monthKey]) monthlyStats[t.monthKey] = { pnl:0, trades:0, wins:0 };
                        monthlyStats[t.monthKey].pnl += t.netPnL;
                        monthlyStats[t.monthKey].trades++;
                        
                        if (t.netPnL > 0) {
                            wins++; 
                            sumWin += t.netPnL;
                            monthlyStats[t.monthKey].wins++;
                            currentStreak = currentStreak > 0 ? currentStreak + 1 : 1;
                            maxWinStreak = Math.max(maxWinStreak, currentStreak);
                        } else {
                            losses++; 
                            sumLoss += Math.abs(t.netPnL);
                            currentStreak = currentStreak < 0 ? currentStreak - 1 : -1;
                            maxLossStreak = Math.max(maxLossStreak, Math.abs(currentStreak));
                        }

                        // Equity
                        equity += t.netPnL;
                        peak = Math.max(peak, equity);
                        const dd = equity - peak;
                        maxDD = Math.min(maxDD, dd);
                        
                        equityCurve.push({ x: t.dateStr, y: equity, dd: dd });
                    });

                    const totalTrades = trades.length;
                    const winRate = (wins/totalTrades)*100;
                    const avgWin = wins ? sumWin/wins : 0;
                    const avgLoss = losses ? sumLoss/losses : 0; // positive number
                    const profitFactor = sumLoss ? sumWin/sumLoss : 0;
                    const totalPnL = equity;
                    
                    return {
                        trades,
                        metrics: {
                            totalTrades, winRate, totalPnL, maxDD,
                            avgWin, avgLoss, profitFactor,
                            rrRatio: avgLoss ? avgWin/avgLoss : 0,
                            maxWinStreak, maxLossStreak,
                            expectancy: (winRate/100 * avgWin) - ((100-winRate)/100 * avgLoss)
                        },
                        equityCurve,
                        monthlyStats
                    };

                } catch (err) {
                    throw new Error(err.message);
                }
            }, [rawText]);
        };

        // --- COMPONENTS ---

        const VerdictSection = ({ metrics }) => {
            const { profitFactor, winRate, rrRatio, totalPnL } = metrics;
            
            let title = "The Balanced Trader";
            let description = "Your trading shows a mix of styles. You are neither purely scalping nor purely trend following.";
            let grade = "C";
            let color = "text-yellow-600";

            if (totalPnL < 0) {
                title = "The Struggling Trader";
                description = "Currently, the strategy is losing money. Focus on cutting losses earlier or increasing your win rate.";
                grade = "D";
                color = "text-red-600";
            } else if (profitFactor > 2.0) {
                title = "The Market Master";
                description = "Exceptional performance. Your system is highly efficient with great risk management.";
                grade = "A+";
                color = "text-green-600";
            } else if (winRate < 45 && rrRatio > 2.0) {
                title = "The Sniper (Trend Follower)";
                description = "You take few shots and miss often, but when you hit, you hit BIG. This is a psychologically hard but professionally respected style.";
                grade = "A-";
                color = "text-blue-600";
            } else if (winRate > 60 && rrRatio < 1.0) {
                title = "The Scalper";
                description = "You rely on high accuracy to make money. Be careful of one big loss wiping out many small wins.";
                grade = "B";
                color = "text-purple-600";
            }

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6 relative overflow-hidden print-break">
                    <div className="absolute top-0 right-0 p-4 opacity-5">
                        <Icon name="award" size={120} />
                    </div>
                    <div className="relative z-10 flex flex-col md:flex-row gap-6 items-start md:items-center">
                        <div className={`w-20 h-20 rounded-full flex items-center justify-center text-3xl font-bold bg-slate-50 border-4 ${color.replace('text', 'border')}`}>
                            <span className={color}>{grade}</span>
                        </div>
                        <div>
                            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-1">Performance Verdict</h3>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">{title}</h2>
                            <p className="text-slate-600 max-w-2xl">{description}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const MetricCard = ({ label, value, sub, icon, trend }) => (
            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-between h-full">
                <div className="flex justify-between items-start mb-4">
                    <div className="p-2 bg-slate-50 rounded-lg text-slate-400">
                        <Icon name={icon} />
                    </div>
                    {trend && (
                        <span className={`text-xs font-bold px-2 py-1 rounded-full ${trend === 'good' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                            {trend === 'good' ? 'Healthy' : 'Warning'}
                        </span>
                    )}
                </div>
                <div>
                    <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
                    <p className="text-xs text-slate-500 font-medium uppercase mt-1">{label}</p>
                    {sub && <p className="text-xs text-slate-400 mt-2 border-t pt-2 border-slate-100">{sub}</p>}
                </div>
            </div>
        );

        const MonthlyBreakdown = ({ stats }) => {
            const months = Object.keys(stats);
            return (
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden print-break">
                    <div className="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                            <Icon name="calendar" size={16} /> Monthly Performance
                        </h3>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                <tr>
                                    <th className="px-6 py-3">Month</th>
                                    <th className="px-6 py-3 text-right">Trades</th>
                                    <th className="px-6 py-3 text-right">Win Rate</th>
                                    <th className="px-6 py-3 text-right">Net P&L</th>
                                    <th className="px-6 py-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {months.map(m => {
                                    const s = stats[m];
                                    const wr = (s.wins / s.trades) * 100;
                                    return (
                                        <tr key={m} className="border-b last:border-0 hover:bg-slate-50 transition">
                                            <td className="px-6 py-4 font-medium text-slate-800">{m}</td>
                                            <td className="px-6 py-4 text-right">{s.trades}</td>
                                            <td className="px-6 py-4 text-right">{wr.toFixed(0)}%</td>
                                            <td className={`px-6 py-4 text-right font-bold ${s.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {s.pnl.toLocaleString('en-IN', { style: 'currency', currency: 'INR' })}
                                            </td>
                                            <td className="px-6 py-4 text-center">
                                                {s.pnl >= 0 ? 
                                                    <span className="inline-block w-2 h-2 rounded-full bg-green-500"></span> : 
                                                    <span className="inline-block w-2 h-2 rounded-full bg-red-500"></span>
                                                }
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const DurationChart = ({ trades }) => {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                if(!trades || !canvasRef.current) return;
                
                // Filter outliers (> 3 days for clearer chart)
                const validTrades = trades.filter(t => t.durationMins < 4000); 

                const ctx = canvasRef.current.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                label: 'Winning Trade',
                                data: validTrades.filter(t => t.netPnL > 0).map(t => ({ x: t.durationMins, y: t.netPnL })),
                                backgroundColor: 'rgba(34, 197, 94, 0.6)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Losing Trade',
                                data: validTrades.filter(t => t.netPnL <= 0).map(t => ({ x: t.durationMins, y: t.netPnL })),
                                backgroundColor: 'rgba(239, 68, 68, 0.6)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            tooltip: { 
                                callbacks: { 
                                    label: (c) => ` ₹ ${c.raw.y.toFixed(0)} (${Math.round(c.raw.x)} mins)` 
                                } 
                            },
                            legend: { position: 'top' }
                        },
                        scales: {
                            x: { 
                                type: 'linear', 
                                position: 'bottom', 
                                title: { display: true, text: 'Duration (Minutes)' },
                                grid: { display: false }
                            },
                            y: { 
                                title: { display: true, text: 'Profit / Loss (₹)' },
                                grid: { color: '#f1f5f9' }
                            }
                        }
                    }
                });
                return () => chart.destroy();
            }, [trades]);

            return <canvas ref={canvasRef} />;
        };

        const EquityChart = ({ curve }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if(!curve || !canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: curve.map(d => d.x),
                        datasets: [{
                            label: 'Equity',
                            data: curve.map(d => d.y),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { grid: { color: '#f1f5f9' } } }
                    }
                });
                return () => chart.destroy();
            }, [curve]);
            return <canvas ref={canvasRef} />;
        };

        // --- MAIN APP ---
        const App = () => {
            const [csvText, setCsvText] = useState(null);
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);

            const analysis = useTradeAnalysis(csvText);

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    setCsvText(ev.target.result);
                    setError(null);
                };
                reader.onerror = () => setError("Failed to read file");
                reader.readAsText(file);
            };

            return (
                <div className="min-h-screen pb-12">
                    {/* NAVBAR */}
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-30 no-print">
                        <div className="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 p-2 rounded-lg text-white">
                                    <Icon name="activity" />
                                </div>
                                <span className="font-bold text-lg text-slate-800 tracking-tight">TradeAudit<span className="text-blue-600">Pro</span></span>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="text-xs text-slate-400 hidden md:flex items-center gap-1 bg-slate-50 px-3 py-1 rounded-full border border-slate-100">
                                    <Icon name="lock" size={12} /> Privacy: Data never leaves your device
                                </span>
                                {analysis && (
                                    <button onClick={() => window.print()} className="p-2 text-slate-500 hover:text-slate-800 hover:bg-slate-100 rounded-full transition" title="Print Report">
                                        <Icon name="printer" />
                                    </button>
                                )}
                                <button 
                                    onClick={() => fileInputRef.current.click()}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition shadow-sm shadow-blue-200"
                                >
                                    <Icon name="upload-cloud" size={16} /> 
                                    {csvText ? "Upload New" : "Upload CSV"}
                                </button>
                                <input type="file" ref={fileInputRef} onChange={handleFile} accept=".csv" className="hidden" />
                            </div>
                        </div>
                    </nav>

                    {/* HERO / EMPTY STATE */}
                    {!analysis && (
                        <div className="max-w-4xl mx-auto mt-20 px-6 text-center">
                            <div className="bg-white p-12 rounded-2xl border-2 border-dashed border-slate-300 shadow-sm">
                                <div className="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Icon name="file-spreadsheet" size={40} />
                                </div>
                                <h2 className="text-3xl font-bold text-slate-800 mb-4">Analyze your Trading Journal</h2>
                                <p className="text-slate-500 mb-8 max-w-lg mx-auto">
                                    Upload your broker's tradebook CSV. We process everything locally in your browser to generate professional-grade insights.
                                </p>
                                <div className="flex justify-center gap-4">
                                    <button 
                                        onClick={() => fileInputRef.current.click()}
                                        className="bg-slate-900 text-white px-6 py-3 rounded-xl font-medium hover:bg-slate-800 transition shadow-lg shadow-slate-200"
                                    >
                                        Select CSV File
                                    </button>
                                </div>
                                <p className="text-xs text-slate-400 mt-6">Supported: Kotak, Zerodha, Standard CSV formats</p>
                            </div>
                        </div>
                    )}

                    {error && (
                        <div className="max-w-6xl mx-auto px-6 mt-8">
                            <div className="bg-red-50 text-red-700 p-4 rounded-xl border border-red-200 flex items-center gap-3">
                                <Icon name="alert-triangle" /> {error}
                            </div>
                        </div>
                    )}

                    {/* REPORT DASHBOARD */}
                    {analysis && (
                        <main className="max-w-6xl mx-auto px-6 mt-8 space-y-8">
                            
                            {/* 1. VERDICT */}
                            <VerdictSection metrics={analysis.metrics} />

                            {/* 2. KPI GRID */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <MetricCard 
                                    label="Net P&L" 
                                    value={analysis.metrics.totalPnL.toLocaleString('en-IN', { style: 'currency', currency: 'INR' })}
                                    trend={analysis.metrics.totalPnL > 0 ? 'good' : 'bad'}
                                    sub="After all charges"
                                    icon="wallet"
                                />
                                <MetricCard 
                                    label="Win Rate" 
                                    value={analysis.metrics.winRate.toFixed(1) + "%"}
                                    trend={analysis.metrics.winRate > 40 ? 'good' : 'bad'}
                                    sub={`Out of ${analysis.metrics.totalTrades} trades`}
                                    icon="crosshair"
                                />
                                <MetricCard 
                                    label="Profit Factor" 
                                    value={analysis.metrics.profitFactor.toFixed(2)}
                                    trend={analysis.metrics.profitFactor > 1.5 ? 'good' : 'bad'}
                                    sub="Gross Win / Gross Loss"
                                    icon="bar-chart-2"
                                />
                                <MetricCard 
                                    label="Max Drawdown" 
                                    value={analysis.metrics.maxDD.toLocaleString('en-IN', { style: 'currency', currency: 'INR' })}
                                    trend="bad"
                                    sub="Peak to Trough drop"
                                    icon="trending-down"
                                />
                            </div>

                            {/* 3. CHARTS ROW */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 print-break">
                                <div className="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                        <Icon name="line-chart" size={18} /> Equity Curve
                                    </h3>
                                    <div className="h-64">
                                        <EquityChart curve={analysis.equityCurve} />
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                        <Icon name="shield-alert" size={18} /> Risk Stats
                                    </h3>
                                    <div className="space-y-4">
                                        <div className="flex justify-between py-2 border-b border-slate-50">
                                            <span className="text-slate-500 text-sm">Avg Win</span>
                                            <span className="font-mono font-medium text-green-600">₹{analysis.metrics.avgWin.toFixed(0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-b border-slate-50">
                                            <span className="text-slate-500 text-sm">Avg Loss</span>
                                            <span className="font-mono font-medium text-red-600">₹{analysis.metrics.avgLoss.toFixed(0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-b border-slate-50">
                                            <span className="text-slate-500 text-sm">Risk:Reward</span>
                                            <span className="font-mono font-medium text-slate-800">1 : {analysis.metrics.rrRatio.toFixed(2)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-b border-slate-50">
                                            <span className="text-slate-500 text-sm">Expectancy</span>
                                            <span className="font-mono font-medium text-blue-600">₹{analysis.metrics.expectancy.toFixed(0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2">
                                            <span className="text-slate-500 text-sm">Max Loss Streak</span>
                                            <span className="font-mono font-medium text-red-600">{analysis.metrics.maxLossStreak} Trades</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 4. DEEP DIVE SECTION */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 print-break">
                                {/* DURATION ANALYSIS */}
                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                            <Icon name="clock" size={18} /> Time vs Profit
                                        </h3>
                                        <span className="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">Are you holding losers too long?</span>
                                    </div>
                                    <div className="h-64">
                                        <DurationChart trades={analysis.trades} />
                                    </div>
                                </div>

                                {/* MONTHLY HEATMAP */}
                                <MonthlyBreakdown stats={analysis.monthlyStats} />
                            </div>

                        </main>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
